---
title: "Figure 2 and associated supplementary figures"
output: html_notebook
author: Grace Avecilla
---

What is the best inference method?

```{r libs and functions}
library(tidyverse)
library(patchwork)
library(scales)
library(ggbeeswarm)
theme_set(theme_classic(base_size = 15))

read_est_params = function(x) {
  if(str_detect(x, "NPE")==TRUE){
    file = read_csv(x, col_names = c("Model","Method","col_to_sep",
                                     "s_est","mu_real",
                                     "mu_est","s_snv","m_snv","rmse_map",
                                     "mean_rmse_ppc","rmse95_low_ppc","rmse95_hi_ppc",
                                     "corr_map",
                                     "mean_corr_ppc","corr95_low_ppc", "corr95_hi_ppc",
                                     "fit_95hdi_low","fit_95hdi_high",
                                     "mut_95hdi_low","mut_95hdi_high",
                                     "aic", "dic", "waic1", "waic2")) %>%
      separate(col_to_sep, into = c(NA,NA,NA,"n_presim", "presim_rep","s_real"), 
               sep="([_.])") %>%
      mutate(s_real = str_remove(s_real, "csv")) %>%
      mutate(s_est_10 = s_est, s_real_10 = as.numeric(s_real),
             mu_est_10 = mu_est, mu_real_10 = mu_real,
             s_est = 10^s_est, s_real = 10^as.numeric(s_real),
             mu_est = 10^mu_est, mu_real = 10^mu_real) %>%
      mutate(mu_ratio = mu_est/mu_real, s_ratio = s_est/s_real,
             mu_diff = mu_est - mu_real, s_diff = s_est - s_real) %>%
      mutate(flow_type = if_else(str_detect(x, "nsf"), "NSF", "MAF"))
  }
  if(str_detect(x, "ABC")==TRUE) {
    file = read_csv(x, col_names = c("Model","Method","col_to_sep",
                                     "s_est","mu_real",
                                     "mu_est","s_snv","m_snv","rmse_map",
                                     "mean_rmse_ppc","rmse95_low_ppc","rmse95_hi_ppc",
                                     "corr_map",
                                     "mean_corr_ppc","corr95_low_ppc", "corr95_hi_ppc",
                                     "fit_95hdi_low","fit_95hdi_high",
                                     "mut_95hdi_low","mut_95hdi_high",
                                     "aic", "dic", "waic1", "waic2")) %>%
      separate(col_to_sep, into = c("n_presim","s_real"), 
               sep="([-])") %>%
      mutate(s_real = as.numeric(s_real)*-1) %>%
      mutate(presim_rep = case_when(str_detect(x, "_1_") ~ "1",
                                    str_detect(x, "_2_") ~ "2",
                                    str_detect(x, "_3_") ~ "3")) %>%
      select("Model","Method","n_presim", "presim_rep","s_real",
             "s_est","mu_real",
             "mu_est","s_snv","m_snv","rmse_map",
             "mean_rmse_ppc","rmse95_low_ppc","rmse95_hi_ppc",
             "corr_map",
             "mean_corr_ppc","corr95_low_ppc", "corr95_hi_ppc",
             "fit_95hdi_low","fit_95hdi_high",
             "mut_95hdi_low","mut_95hdi_high",
             "aic", "dic", "waic1", "waic2") %>%
      mutate(s_est_10 = s_est, s_real_10 = as.numeric(s_real),
             mu_est_10 = mu_est, mu_real_10 = mu_real,
             s_est = 10^s_est, s_real = 10^as.numeric(s_real),
             mu_est = 10^mu_est, mu_real = 10^mu_real) %>%
      mutate(mu_ratio = mu_est/mu_real, s_ratio = s_est/s_real,
             mu_diff = mu_est - mu_real, s_diff = s_est - s_real) %>%
      mutate(flow_type = NA) %>%
      mutate(n_presim = if_else(n_presim == "100", "10000", "100000"))
  }
  return(file)
}
```


```{r get data}
file_dir = "/Volumes/GoogleDrive/.shortcut-targets-by-id/19NQRq-XLPpjqJGmLbP4MHRjala2WVahk/Avecilla et al Simulating CNV evolution/scripts/cnv_sims_inference/hpc_output/test_performance/single/param_estimates/"
files = list.files(path = file_dir, pattern = '*est_real_params.csv')
files = paste0(file_dir, files)
data_list = map(files,read_est_params)
data_all = do.call(rbind, data_list) %>%
  mutate(Method = str_replace(Method, "SNPE", "NPE")) %>%
  mutate(relative_error_mut = (mu_real - mu_est)/mu_real, relative_error_s = (s_real - s_est)/s_real)
# percent in HDR, counted manually
fig_path = "/Volumes/GoogleDrive/.shortcut-targets-by-id/19NQRq-XLPpjqJGmLbP4MHRjala2WVahk/Avecilla et al Simulating CNV evolution/scripts/cnv_sims_inference/figs/"
hdr_data = read_csv(paste0(fig_path, "HDR.csv"))
```

# Figure 2

```{r set up for Fig2}
data = data_all %>% filter(Method == "ABC-SMC" & n_presim=="10000") %>%
  bind_rows(data_all %>% filter(n_presim == "100000" & flow_type == "NSF")) %>% 
  unite(mod_method, Model, Method, sep = " ", remove=F) %>%
  unite(sim_params,s_real, mu_real, remove = F)

color_vec = c("#4daf4a", "#984ea3","#e41a1c", "#377eb8", "black")
mod_meth = c("Chemo NPE", "WF NPE", "Chemo ABC-SMC", "WF ABC-SMC", "Pseudo-observation")

labs <- c("s relative error", expression(paste(delta," relative error")), "Total relative error")
names(labs) <- c("relative_error_s", "relative_error_mut", "total_rel_error")

hdr_data_long = hdr_data %>%
  filter(method == "ABC-SMC" & n_presim=="100") %>% #& rep == "1"
  bind_rows(hdr_data %>% filter(n_presim == 100000 & flow_type == "NSF")) %>% #& rep == 1
  unite(mod_method, model, method, sep = " ", remove=F) %>%
  pivot_longer(cols = starts_with("0."), names_to = "sim_params", values_to = "in_hdr") 

```

```{r a}
a2 = hdr_data_long %>% mutate(in_hdr_prop = in_hdr/5) %>%
  group_by(mod_method, sim_params) %>%
  summarize(mean_in_hdr_prop = mean(in_hdr_prop)) %>%#*100) %>%
  ggplot(aes(sim_params, mean_in_hdr_prop,fill=mod_method)) +#, shape = as.factor(rep))) +
  #geom_boxplot() +
  geom_bar(stat="identity", position="dodge") +
  geom_point(data=hdr_data_long %>% mutate(in_hdr_prop = in_hdr/5), 
             aes(sim_params, in_hdr_prop,fill=mod_method,shape = as.factor(rep)),
             color="black",
             position = position_dodge2(width = 1),
             size=3) +
  scale_fill_manual(values=color_vec,name="", breaks=mod_meth) +
  scale_shape_manual(values = c(21, 22, 23), name = "Training set") +
  xlab("") +
  ylab("Percent of true parameters\nin 50% HDR") +
  scale_y_continuous(labels = scales::percent) +#, limits = c(0,100)) +
  ggtitle("A") +
  scale_x_discrete(labels=c("0.001_1e-7"  = expression(atop("s = 0.001,", paste(delta, "  = 1e-7"))),
                                                                                  "0.001_1e-5" = expression(atop("s = 0.001,", paste(delta, "  = 1e-5"))), 
                                                                                  "0.1_1e-7"  = expression(atop("s = 0.1,", paste(delta, "  = 1e-7"))),
                                                                                  "0.1_1e-5"  = expression(atop("s = 0.1,", paste(delta, "  = 1e-5"))))) 
a2
```
*A)* Percentage of true parameters within the 50% HDR. For NPE, each training set corresponds to an independent amortized posterior trained with 100,000 simulations, with which each observation was evaluated. For ABC-SMC, each training set corresponds to independent inference procedures on each observation using a total simulation budget of 100,000 and the stopping criteria of 10 rounds or Îµ <= 0.002. The bar height shows the average of three training sets.

```{r b}
b2 = data %>% mutate(fit_hdi_width= 10^fit_95hdi_high - 10^fit_95hdi_low) %>%
  ggplot(aes(sim_params, fit_hdi_width, color = mod_method))  +
  geom_boxplot(outlier.shape = NA, position = position_dodge2(width=1))+
  scale_color_manual(values=color_vec, 
                     name="",
                     breaks=mod_meth) +
  geom_beeswarm(aes(fill=mod_method, shape = as.factor(presim_rep)), dodge.width = .7, alpha = 0.5) +#,dodge.width = 1, size=1, cex=3, shape = 21, color="black") +
  #geom_point(aes(fill=mod_method,shape = as.factor(presim_rep)),
    #         color="black",
     #        position = position_dodge2(width = 0.7),
      #       size=1.5) +
  scale_shape_manual(values = c(21, 22, 23), name = "Training set") +
  scale_fill_manual(values=color_vec, 
                     name="",
                     limits=mod_meth, guide = 'none') +
  ylab("s 95% HDI width") +
  xlab("") +
  theme(legend.position = "none") +
  scale_x_discrete(labels=c("0.001_1e-07"  = expression(atop("s = 0.001,", paste(delta, "  = 1e-7"))),
                            "0.001_1e-05" = expression(atop("s = 0.001,", paste(delta, "  = 1e-5"))), 
                            "0.1_1e-07"  = expression(atop("s = 0.1,", paste(delta, "  = 1e-7"))),
                            "0.1_1e-05"  = expression(atop("s = 0.1,", paste(delta, "  = 1e-5"))))) +
  ggtitle("B")
b2
```

*B)* Distribution of widths of the fitness effect s 95% highest density interval (HDI) calculated as the difference between the 97.5 percentile and 2.5 percentile, for each inferred posterior distribution. 
```{r c}
c2 = data %>%
  mutate(mut_hdi_width= mut_95hdi_high - mut_95hdi_low) %>%
  ggplot(aes(sim_params, mut_hdi_width, color = mod_method)) +
  geom_boxplot(outlier.shape = NA, position = position_dodge2(width=1))+
  scale_color_manual(values=color_vec, 
                     name="",
                     breaks=mod_meth) +
  geom_beeswarm(aes(fill=mod_method, shape = as.factor(presim_rep)), dodge.width = .7, alpha = 0.5) +
  scale_shape_manual(values = c(21, 22, 23), name = "Training set") +
  scale_fill_manual(values=color_vec, 
                    name="",
                    limits=mod_meth, guide = 'none') +
  scale_y_log10() +
  ylab(expression(paste(delta," 95% HDI width, log10"))) +
  xlab("") +
  scale_x_discrete(labels=c("0.001_1e-07"  = expression(atop("s = 0.001,", paste(delta, "  = 1e-7"))),
                            "0.001_1e-05" = expression(atop("s = 0.001,", paste(delta, "  = 1e-5"))), 
                            "0.1_1e-07"  = expression(atop("s = 0.1,", paste(delta, "  = 1e-7"))),
                            "0.1_1e-05"  = expression(atop("s = 0.1,", paste(delta, "  = 1e-5"))))) +
  ggtitle("C")
c2
```
*C)* Distribution of the number of orders of magnitude encompassed by the mutation rate ð›¿ 95% HDI, calculated as difference of the base 10 logarithms of the 97.5 percentile and 2.5 percentile, for each inferred posterior distribution

```{r d}
data$sim_params = factor(data$sim_params, levels = c("0.001_1e-05", "0.001_1e-07", "0.1_1e-05", "0.1_1e-07"),
                         ordered = TRUE, labels=c(expression(atop("s = 0.001,", paste(delta, "  = 1e-5"))),
                                                  expression(atop("s = 0.001,", paste(delta, "  = 1e-7"))),
                                                  "0.1_1e-05"  = expression(atop("s = 0.1,", paste(delta, "  = 1e-5"))),
                                                  "0.1_1e-07"  = expression(atop("s = 0.1,", paste(delta, "  = 1e-7")))))


data_d = data %>%
  pivot_longer(cols = c("mu_ratio", "s_ratio"), 
               names_to = "error_type", values_to = "log10 ( MAP parameter / true parameter )") %>%
  mutate(`log10 ( MAP parameter / true parameter )` = log10(`log10 ( MAP parameter / true parameter )`))
 # mutate(total_rel_error = relative_error_mut+relative_error_s) %>%
 # pivot_longer(cols = c("relative_error_mut", "relative_error_s"),  #"total_rel_error", 
  #             names_to = "error_type", values_to = "Relative error") 

d2 = data_d %>%
  ggplot(aes(error_type,`log10 ( MAP parameter / true parameter )`, color=mod_method)) +
  geom_boxplot(outlier.shape = NA, position = position_dodge2(width=1))+
  scale_color_manual(values=color_vec, 
                     name="",
                     breaks=mod_meth) +
  geom_beeswarm(aes(fill=mod_method, shape = as.factor(presim_rep)), dodge.width = .7, alpha = 0.5) +
  scale_shape_manual(values = c(21, 22, 23), name = "Training set") +
  scale_fill_manual(values=color_vec, 
                    name="",
                    limits=mod_meth, guide = 'none') +
  xlab("") +
  #ylab("MAP relative error") +
  facet_wrap(~sim_params, labeller=label_parsed, scales = "free", ncol=4) +
  scale_x_discrete(labels=c("s_ratio"  = "s",
                            "mu_ratio" = expression(delta))) + 
                            #"total_rel_error"  = "total")) +
  #xlab("Relative error type") +
  theme(panel.spacing.x=unit(1, "lines")) +
  ggtitle("D") +
  geom_hline(yintercept = 0, alpha = 0.5) 
d2
```
*D)* Ratio of MAP estimate to true parameters as compared to true parameters, log transformed for s and  Î´C. Note that each panel has a different y axis. Zero (grey line) indicates no difference between MAP and true parameters.
```{r E}
e2 = data %>%
  ggplot(aes(mod_method,mean_rmse_ppc, color=mod_method, fill=mod_method, shape=as.factor(presim_rep))) +
  #geom_point(position=position_jitter()) +
  geom_pointrange(aes(ymin = rmse95_low_ppc,ymax = rmse95_hi_ppc), alpha=0.5,
                  position=position_dodge2(width=0.75)) +
  scale_shape_manual(values = c(21, 22, 23), name = "Training set") +
  scale_color_manual(values=color_vec, 
                     name="",
                     breaks=mod_meth) +
  scale_fill_manual(values=color_vec, 
                    name="",
                    limits=mod_meth, guide = 'none') +
  facet_wrap(~sim_params, labeller=label_parsed, ncol=4,strip.position="bottom") +
  xlab("") +
  #theme(legend.position = "none") +
  ylab("Posterior predictive check \nroot mean square error") +
  theme(axis.text.x=element_blank()) +
  ggtitle("E")
e2
```

*E)* Mean and 95% confidence interval for RMSE of 50 posterior predictions as compared to the synthetic observation for which inference was performed.

```{r Figure 2}
layout <- "
ABC
DDD
EEE
"
fig2 = a2 + b2 + c2 + d2 + e2 + 
  plot_layout(design = layout)
fig2
ggsave(paste0(fig_path,"Figure2.pdf"), plot = fig2, width = 18, height = 15, units = "in")
ggsave(paste0(fig_path,"Figure2.png"), plot = fig2, width = 18, height = 15, units = "in")

```

old figure 2 legend   
Figure 2  Performance assessment of learning methods using single experiment simulated synthetic observations. A) A simulated observation specifying the proportion of the population containing GAP1 CNVs over time generated from a Wright-Fisher model with CNV selection coefficient s= 0.1, CNV mutation rate ð›¿C= 10-7, SNV selective coefficient = 0.001, and SNV mutation rate = 10-5. B) The joint posterior distribution estimated by ABC-SMC for the simulation in panel A. The true parameter values are shown in red and the maximum a posteriori (MAP) estimate is shown in black. The 50% and 95% highest density regions (HDR) are denoted by grey and white curves, respectively. C) Posterior predictive plot using the posterior distribution shown in panel B. The synthetic observation is shown in black; the posterior prediction using the MAP parameter values is shown in dark blue; predictions using  fifty samples from the posterior distribution are shown in light blue. D) Percentage of true parameters within the 50% HDR. For NPE, each training set corresponds to an independent amortized posterior trained with 100,000 simulations, with which each observation was evaluated. For ABC-SMC, each training set corresponds to independent inference procedures on each observation using a total simulation budget of 100,000 and the stopping criteria of 10 rounds or Îµ <= 0.002. The bar height shows the average of three training sets. E-K) Show the results of inference on five simulated synthetic observations using either the Wright-Fisher (WF) or chemostat (Chemo) model per combination of fitness effect s and mutation rate ð›¿C. Here we show the results of performing one training set with NPE using 100,000 simulations for training and using the same amortized network to infer a posterior for each replicate synthetic observation. For this single training set, the ABC-SMC inference procedure was performed with a total simulation budget of 100,000 and the stopping criteria of 10 iterations or Îµ <= 0.002. E) Distribution of widths of the fitness effect s 95% highest density interval (HDI) calculated as the difference between the 97.5 percentile and 2.5 percentile, for each inferred posterior distribution. F) Distribution of the number of orders of magnitude encompassed by the mutation rate ð›¿ 95% HDI, calculated as difference of the base 10 logarithms of the 97.5 percentile and 2.5 percentile, for each inferred posterior distribution. G) Relative error of MAP estimate as compared to true parameters for s,  Î´C, and total relative error. Note that each panel has a different y axis. H) Mean and 95% confidence interval for RMSE of 50 posterior predictions as compared to the synthetic observation for which inference was performed. I) Mean and 95% confidence interval for correlation coefficient of 50 posterior predictions compared to the synthetic observation for which inference was performed.

# Supplemental Figures

```{r sup fig 1}
data_s = data_all %>% filter(n_presim == "100000" & flow_type == "MAF") %>% # & presim_rep == "2"
  unite(mod_method, Model, Method, flow_type, sep = " ", remove=F) %>%
  unite(sim_params,s_real, mu_real, remove = F)

hdr_data_long = hdr_data %>% filter(n_presim == 100000 & flow_type == "MAF") %>% 
  unite(mod_method, model, method, flow_type, sep = " ", remove=F) %>%
  pivot_longer(cols = starts_with("0."), names_to = "sim_params", values_to = "in_hdr") 

a_supp = hdr_data_long %>% mutate(in_hdr_prop = in_hdr/5) %>%
  group_by(mod_method, sim_params) %>%
  summarize(mean_in_hdr_prop = mean(in_hdr_prop)) %>%#*100) %>%
  ggplot(aes(sim_params, mean_in_hdr_prop,fill=mod_method)) +#, shape = as.factor(rep))) +
  #geom_boxplot() +
  geom_bar(stat="identity", position="dodge") +
  geom_point(data=hdr_data_long %>% mutate(in_hdr_prop = in_hdr/5), 
             aes(sim_params, in_hdr_prop,fill=mod_method,shape = as.factor(rep)),
             color="black",
             position = position_jitterdodge(dodge.width = 1),
             size=3) +
  scale_fill_manual(values=color_vec,name="", breaks=mod_meth) +
  scale_shape_manual(values = c(21, 22, 23), name = "Training set") +
  xlab("") +
  ylab("Percent of true parameters\nin 50% HDR") +
  scale_y_continuous(labels = scales::percent) +#, limits = c(0,100)) +
  ggtitle("A") +
  #ylim(c(0,100)) +
  scale_x_discrete(labels=c("0.001_1e-7"  = expression(atop("s = 0.001,", paste(delta, "  = 1e-7"))),
                            "0.001_1e-5" = expression(atop("s = 0.001,", paste(delta, "  = 1e-5"))), 
                            "0.1_1e-7"  = expression(atop("s = 0.1,", paste(delta, "  = 1e-7"))),
                            "0.1_1e-5"  = expression(atop("s = 0.1,", paste(delta, "  = 1e-5"))))) 

b_supp = data_s %>% mutate(fit_hdi_width= 10^fit_95hdi_high - 10^fit_95hdi_low) %>%
  ggplot(aes(sim_params, fit_hdi_width, color = mod_method)) + #, shape = as.factor(presim_rep))) +
  #geom_point(position = position_jitterdodge()) +
  geom_boxplot() +
  scale_color_manual(values=color_vec, 
                     name="",
                     breaks=mod_meth) +
  ylab("s 95% HDI width") +
  xlab("") +
  theme(legend.position = "none") +
  scale_x_discrete(labels=c("0.001_1e-07"  = expression(atop("s = 0.001,", paste(delta, "  = 1e-7"))),
                            "0.001_1e-05" = expression(atop("s = 0.001,", paste(delta, "  = 1e-5"))), 
                            "0.1_1e-07"  = expression(atop("s = 0.1,", paste(delta, "  = 1e-7"))),
                            "0.1_1e-05"  = expression(atop("s = 0.1,", paste(delta, "  = 1e-5"))))) +
  ggtitle("B")

c_supp = data_s %>%
  mutate(mut_hdi_width= mut_95hdi_high - mut_95hdi_low) %>%
  ggplot(aes(sim_params, mut_hdi_width, color = mod_method)) +#, shape = as.factor(presim_rep))) +
  #geom_point(position = position_jitterdodge()) +
  geom_boxplot() +
  scale_color_manual(values=color_vec, 
                     name="",
                     breaks=mod_meth) +
  scale_y_log10() +
  ylab(expression(paste(delta," 95% HDI width, log10"))) +
  xlab("") +
  scale_x_discrete(labels=c("0.001_1e-07"  = expression(atop("s = 0.001,", paste(delta, "  = 1e-7"))),
                            "0.001_1e-05" = expression(atop("s = 0.001,", paste(delta, "  = 1e-5"))), 
                            "0.1_1e-07"  = expression(atop("s = 0.1,", paste(delta, "  = 1e-7"))),
                            "0.1_1e-05"  = expression(atop("s = 0.1,", paste(delta, "  = 1e-5"))))) +
  ggtitle("C")

data_s$sim_params = factor(data_s$sim_params, levels = c("0.001_1e-05", "0.001_1e-07", "0.1_1e-05", "0.1_1e-07"),
                         ordered = TRUE, labels=c("0.001_1e-05"  =expression(atop("s = 0.001,", paste(delta, "  = 1e-5"))),
                                                  "0.001_1e-07" = expression(atop("s = 0.001,", paste(delta, "  = 1e-7"))),
                                                  "0.1_1e-05"  = expression(atop("s = 0.1,", paste(delta, "  = 1e-5"))),
                                                  "0.1_1e-07"  = expression(atop("s = 0.1,", paste(delta, "  = 1e-7")))))



data_d = data_s %>%
  pivot_longer(cols = c("mu_ratio", "s_ratio"), 
               names_to = "error_type", values_to = "log10 ( MAP parameter / true parameter )") %>%
  mutate(`log10 ( MAP parameter / true parameter )` = log10(`log10 ( MAP parameter / true parameter )`))

d_supp = data_d %>% 
  ggplot(aes(error_type,`log10 ( MAP parameter / true parameter )`, color=mod_method)) +
  geom_boxplot() +
  geom_point(aes(shape=presim_rep),position = position_jitterdodge()) +
  scale_color_manual(values=color_vec, 
                     name="",
                     breaks=mod_meth) +
  xlab("") +
  ylab("MAP relative error") +
  facet_wrap(~sim_params, labeller=label_parsed, scales = "free", ncol=4) +
  scale_x_discrete(labels=c("s_ratio"  = "s",
                            "mu_ratio" = expression(delta))) +
  xlab("Relative error type") +
  theme(panel.spacing.x=unit(1, "lines")) +
  ggtitle("D")


e_supp = data_s %>%
  ggplot(aes(mod_method,mean_rmse_ppc, color=mod_method)) +
  #geom_point(position=position_jitter()) +
  geom_pointrange(aes(ymin = rmse95_low_ppc,ymax = rmse95_hi_ppc), alpha=0.5,
                  position=position_jitter()) +
  scale_color_manual(values=color_vec, 
                     name="",
                     breaks=mod_meth) +
  facet_wrap(~sim_params, labeller=label_parsed, ncol=4,strip.position="bottom") +
  xlab("") +
  ylab("Posterior predictive check \nroot mean square error") +
  theme(axis.text.x=element_blank()) +
  ggtitle("E")

f_supp = data_s %>%
  #  ggplot(aes(sim_params,rmse_map, color=mod_method)) +
  ggplot(aes(mod_method,rmse_map, color=mod_method)) +
  facet_wrap(~sim_params, labeller=label_parsed, ncol=4,strip.position="bottom") +
  geom_boxplot() +
  geom_point(position = position_jitterdodge()) +
  theme(axis.text.x=element_blank()) +
  scale_color_manual(values=color_vec, 
                     name="",
                     breaks=mod_meth) +
  xlab("") +
  ylab("MAP posterior prediction \nroot mean square error") +
  ggtitle("F")


g_supp = data_s %>%
  ggplot(aes(mod_method,mean_corr_ppc, color=mod_method)) +
  #geom_point(position=position_jitter()) +
  geom_pointrange(aes(ymin = corr95_low_ppc,ymax = corr95_hi_ppc), alpha=0.5,
                  position=position_jitter()) +
  scale_color_manual(values=color_vec, 
                     name="",
                     breaks=mod_meth) +
  facet_wrap(~sim_params, labeller=label_parsed, ncol=4,strip.position="bottom") +
  xlab("") +
  ylab("Posterior predictive check \ncorrelation coefficient") +
  theme(axis.text.x=element_blank()) +
  ggtitle("G")

h_supp = data_s %>%
  #  ggplot(aes(sim_params,corr_map, color=mod_method)) +
  ggplot(aes(mod_method,corr_map, color=mod_method)) +
  facet_wrap(~sim_params, labeller=label_parsed, ncol=4,strip.position="bottom") +
  geom_boxplot() +
  geom_point(position = position_jitterdodge()) +
  scale_color_manual(values=color_vec, 
                     name="",
                     breaks=mod_meth) +
  theme(axis.text.x=element_blank()) +
  ylim(c(-0.2,1)) +
  xlab("") +
  ylab("MAP posterior prediction \ncorrelation coefficient") +
  ggtitle("H")

layout <- "
AABBCC
DDDDDD
EEEEFF
GGGGHH
"
supp = a_supp + b_supp + c_supp + d_supp + e_supp + f_supp + g_supp + h_supp +
  plot_layout(design = layout)
supp
ggsave(paste0(fig_path,"SupplementaryFig1.pdf"), plot = supp, width = 18, height = 15, units = "in")
ggsave(paste0(fig_path,"SupplementaryFig1.png"), plot = supp, width = 18, height = 15, units = "in")
```
*Supplementary Figure 1* Performance assessment of NPE with MAF using single simulated synthetic observations. These show the results of inference on five simulated synthetic observations using either the Wright-Fisher (WF) or chemostat (Chemo) model per combination of fitness effect s and mutation rate ð›¿C. Here we show the results of performing one training set with NPE with MAF using 100,000 simulations for training and using the same amortized network to infer a posterior for each replicate synthetic observation. A) Percentage of true parameters within the 50% HDR. B) Distribution of widths of the fitness effect s 95% highest density interval (HDI) calculated as the difference between the 97.5 percentile and 2.5 percentile, for each inferred posterior distribution. C) Distribution of the number of orders of magnitude encompassed by the mutation rate ð›¿ 95% HDI, calculated as difference of the base 10 logarithms of the 97.5 percentile and 2.5 percentile, for each inferred posterior distribution. D) Relative error of MAP estimate as compared to true parameters for s,  Î´C, and total relative error. Note that each panel has a different y axis. E) Mean and 95% confidence interval for RMSE of 50 posterior predictions as compared to the synthetic observation for which inference was performed. F) RMSE of posterior prediction generated with MAP parameters as compared to the synthetic observation for which inference was performed. G) Mean and 95% confidence interval for correlation coefficient of 50 posterior predictions compared to the synthetic observation for which inference was performed. H) Correlation coefficient of posterior prediction posterior prediction generated with MAP parameters compared to the synthetic observation for which inference was performed.

```{r sup fig 2}
#### supplement map rmse and correlation ####

data$sim_params = factor(data$sim_params, levels = c("0.001_1e-05", "0.001_1e-07", "0.1_1e-05", "0.1_1e-07"),
                         ordered = TRUE, labels=c("0.001_1e-05"  =expression(atop("s = 0.001,", paste(delta, "  = 1e-5"))),
                                                  "0.001_1e-07" = expression(atop("s = 0.001,", paste(delta, "  = 1e-7"))),
                                                  "0.1_1e-05"  = expression(atop("s = 0.1,", paste(delta, "  = 1e-5"))),
                                                  "0.1_1e-07"  = expression(atop("s = 0.1,", paste(delta, "  = 1e-7")))))

a_supp = data %>%
  #  ggplot(aes(sim_params,rmse_map, color=mod_method)) +
  filter(flow_type != "MAF") %>%
  ggplot(aes(mod_method,rmse_map, color=mod_method, shape=as.factor(presim_rep))) +
  facet_wrap(~sim_params, labeller=label_parsed, ncol=4,strip.position="bottom") +
  geom_boxplot() +
  geom_point(aes(fill=mod_method),position = position_jitterdodge()) +
  scale_shape_manual(values = c(21, 22, 23), name = "Training set") +
  theme(legend.position = "none") +
  theme(axis.text.x=element_blank()) +
  scale_color_manual(values=color_vec, 
                     name="",
                     breaks=mod_meth) +
  scale_fill_manual(values=color_vec, 
                    name="",
                    limits=mod_meth, guide = 'none') +
  xlab("") +
  ylab("MAP posterior prediction \nroot mean square error") +
  ggtitle("A")

b_supp = data %>%
  filter(flow_type != "MAF") %>%
  #  ggplot(aes(sim_params,corr_map, color=mod_method)) +
  ggplot(aes(mod_method,corr_map, color=mod_method, shape=as.factor(presim_rep))) +
  facet_wrap(~sim_params, labeller=label_parsed, ncol=4,strip.position="bottom") +
  geom_boxplot() +
  geom_point(aes(fill=mod_method),position = position_jitterdodge()) +
  scale_color_manual(values=color_vec, 
                     name="",
                     breaks=mod_meth) +
  theme(axis.text.x=element_blank()) +
  ylim(c(-0.2,1)) +
  scale_fill_manual(values=color_vec, 
                    name="",
                    limits=mod_meth, guide = 'none') +
  scale_shape_manual(values = c(21, 22, 23), name = "Training set") +
  xlab("") +
  theme(legend.position = "none") +
  ylab("MAP posterior prediction \ncorrelation coefficient") +
  ggtitle("B")

c_supp = data %>%
  filter(flow_type != "MAF") %>%
  ggplot(aes(mod_method,mean_corr_ppc, color=mod_method,fill=mod_method, shape=as.factor(presim_rep))) +
  #geom_point(position=position_jitter()) +
  geom_pointrange(aes(ymin = corr95_low_ppc,ymax = corr95_hi_ppc), alpha=0.5,
                  position=position_dodge2(width=0.75)) +
  scale_shape_manual(values = c(21, 22, 23), name = "Training set") +
  scale_color_manual(values=color_vec, 
                     name="",
                     breaks=mod_meth) +
  scale_fill_manual(values=color_vec, 
                    name="",
                    limits=mod_meth, guide = 'none') +
  facet_wrap(~sim_params, labeller=label_parsed, ncol=4,strip.position="bottom") +
  xlab("") +
  ylab("Posterior predictive check \ncorrelation coefficient") +
  theme(axis.text.x=element_blank()) +
  ggtitle("C")

supp = a_supp + b_supp + c_supp
supp
ggsave(paste0(fig_path,"SupplementaryFig2.pdf"), plot = supp, width = 20, height = 8, units = "in")
ggsave(paste0(fig_path,"SupplementaryFig.png"), plot = supp, width = 20, height = 8, units = "in")


```
*Supplementary Figure 2* These show the results of inference on five simulated single synthetic observations using either the Wright-Fisher (WF) or chemostat (Chemo) model per combination of fitness effect s and mutation rate ð›¿C. Here we show the results of performing one training set with NPE with NSF using 100,000 simulations for training and using the same amortized network to infer a posterior for each replicate synthetic observation. A) RMSE of posterior prediction generated with MAP parameters as compared to the synthetic observation for which inference was performed. B) Correlation coefficient of posterior prediction posterior prediction generated with MAP parameters compared to the synthetic observation for which inference was performed. C) Mean and 95% confidence interval for correlation coefficient of 50 posterior predictions compared to the synthetic observation for which inference was performed.

```{r sup fig 3}
data = data_all %>%
  mutate(flow_type = if_else(!is.na(flow_type),flow_type, "")) %>%
  unite(mod_method, Model, Method, flow_type, sep = " ", remove=F) %>%
  unite(sim_params,s_real, mu_real, remove = F)

color_vec = c("#4daf4a", "#984ea3","#e41a1c", "#377eb8","#f781bf", "#999999")
mod_meth = c("Chemo NPE NSF", "WF NPE NSF", "Chemo ABC-SMC ", "WF ABC-SMC ", "Chemo NPE MAF", "WF NPE MAF")

# aic
supp_a = data %>%
  ggplot(aes(sim_params, aic, color = mod_method)) +
  geom_point(position = position_jitterdodge()) +
  geom_boxplot() +
  scale_color_manual(values=color_vec, 
                     name="",
                     breaks=mod_meth) + 
  #geom_beeswarm(dodge.width = 0.75, alpha =0.5) +
  ylab("AIC") +
  xlab("") +
  facet_wrap(~n_presim) +
  scale_x_discrete(labels=c("0.001_1e-07"  = expression(atop("s = 0.001,", paste(delta, "  = 1e-7"))),
                            "0.001_1e-05" = expression(atop("s = 0.001,", paste(delta, "  = 1e-5"))), 
                            "0.1_1e-07"  = expression(atop("s = 0.1,", paste(delta, "  = 1e-7"))),
                            "0.1_1e-05"  = expression(atop("s = 0.1,", paste(delta, "  = 1e-5"))))) +
  ggtitle("A") +
  theme(legend.position = "none") +
  scale_y_continuous(breaks = seq(-15, 10, by = 1))

# waic1
supp_b = data %>%
  ggplot(aes(sim_params, waic1, color = mod_method)) +
  geom_point(position = position_jitterdodge()) +
  geom_boxplot() +
  scale_color_manual(values=color_vec, 
                     name="",
                     breaks=mod_meth) + 
  #geom_beeswarm(dodge.width = 0.75, alpha =0.5) +
  ylab("WAIC1") +
  xlab("") +
  facet_wrap(~n_presim) +
  scale_x_discrete(labels=c("0.001_1e-07"  = expression(atop("s = 0.001,", paste(delta, "  = 1e-7"))),
                            "0.001_1e-05" = expression(atop("s = 0.001,", paste(delta, "  = 1e-5"))), 
                            "0.1_1e-07"  = expression(atop("s = 0.1,", paste(delta, "  = 1e-7"))),
                            "0.1_1e-05"  = expression(atop("s = 0.1,", paste(delta, "  = 1e-5"))))) +
  ggtitle("B") +
  theme(legend.position = "none")+
  scale_y_continuous(breaks = seq(-15, 10, by = 1))

# waic2
supp_c = data %>%
  ggplot(aes(sim_params, waic2, color = mod_method)) +
  geom_point(position = position_jitterdodge()) +
  geom_boxplot() +
  scale_color_manual(values=color_vec, 
                     name="",
                     breaks=mod_meth) + 
  #geom_beeswarm(dodge.width = 0.75, alpha =0.5) +
  ylab("WAIC2") +
  xlab("") +
  facet_wrap(~n_presim) +
  scale_x_discrete(labels=c("0.001_1e-07"  = expression(atop("s = 0.001,", paste(delta, "  = 1e-7"))),
                            "0.001_1e-05" = expression(atop("s = 0.001,", paste(delta, "  = 1e-5"))), 
                            "0.1_1e-07"  = expression(atop("s = 0.1,", paste(delta, "  = 1e-7"))),
                            "0.1_1e-05"  = expression(atop("s = 0.1,", paste(delta, "  = 1e-5"))))) +
  ggtitle("C")+
  scale_y_continuous(breaks = seq(-15, 10, by = 1))

supp = supp_a + supp_b + supp_c
supp
ggsave(paste0(fig_path,"SupplementaryFig3.pdf"), plot = supp, width = 20, height = 10, units = "in")
ggsave(paste0(fig_path,"SupplementaryFig3.png"), plot = supp, width = 25, height = 10, units = "in")
```
*Supplementary Figure 3* WAIC and AIC for inference on single observations.These show the results of inference on single synthetic observations using either the Wright-Fisher (WF) or chemostat (Chemo) model per combination of fitness effect s and mutation rate ð›¿C, using each different method. The facets show results of inference with simulation budgets of 10,000 or 100,000.

```{r sup fig 4}
data_a = data %>%
  pivot_longer(cols = c("mu_ratio", "s_ratio"), 
               names_to = "error_type", values_to = "log10 ( MAP parameter / true parameter )") %>%
  mutate(`log10 ( MAP parameter / true parameter )` = log10(`log10 ( MAP parameter / true parameter )`))



a_supp = data_a %>%
  ggplot(aes(error_type,`log10 ( MAP parameter / true parameter )`, color=mod_method,)) +
  geom_boxplot() +
  #geom_point(aes(shape=presim_rep),position = position_jitterdodge()) +
  scale_color_manual(values=color_vec, 
                     name="",
                     breaks=mod_meth) +
  xlab("") +
  ylab("MAP relative error") +
  facet_grid(sim_params~n_presim, scales="free", labeller=label_parsed) +
  #facet_wrap(~sim_params, labeller=label_parsed, scales = "free", ncol=4) +
  scale_x_discrete(labels=c("s_ratio"  = "s",
                            "mu_ratio" = expression(delta))) +
  theme(legend.position = "none")+
  xlab("Relative error type") +
  theme(panel.spacing.x=unit(1, "lines")) +
  geom_hline(yintercept = 0, alpha = 0.5) +
  ggtitle("A")

b_supp = data %>% mutate(fit_hdi_width= 10^fit_95hdi_high - 10^fit_95hdi_low) %>%
  ggplot(aes(n_presim, fit_hdi_width, color = mod_method)) + #, shape = as.factor(presim_rep))) +
  #geom_point(position = position_jitterdodge()) +
  geom_boxplot() +
  scale_color_manual(values=color_vec, 
                     name="",
                     breaks=mod_meth) +
  ylab("s 95% HDI width") +
  xlab("Simulation budget") +
  theme(legend.position = "none") +
  scale_x_discrete(labels=c("0.001_1e-07"  = expression(atop("s = 0.001,", paste(delta, "  = 1e-7"))),
                            "0.001_1e-05" = expression(atop("s = 0.001,", paste(delta, "  = 1e-5"))), 
                            "0.1_1e-07"  = expression(atop("s = 0.1,", paste(delta, "  = 1e-7"))),
                            "0.1_1e-05"  = expression(atop("s = 0.1,", paste(delta, "  = 1e-5"))))) +
  ggtitle("B") +
  facet_wrap(~sim_params, labeller=label_parsed, scales = "free", ncol=4)
  #facet_grid(sim_params~n_presim, scales="free")

c_supp = data %>%
  mutate(mut_hdi_width= mut_95hdi_high - mut_95hdi_low) %>%
  ggplot(aes(n_presim, mut_hdi_width, color = mod_method)) +#, shape = as.factor(presim_rep))) +
  #geom_point(position = position_jitterdodge()) +
  geom_boxplot() +
  scale_color_manual(values=color_vec, 
                     name="",
                     breaks=mod_meth) +
  scale_y_log10() +
  ylab(expression(paste(delta," 95% HDI width, log10"))) +
  xlab("Simulation budget") +
  ggtitle("C") +
  facet_wrap(~sim_params, labeller=label_parsed, scales = "free", ncol=4)

supp = a_supp + b_supp + c_supp
supp
ggsave(paste0(fig_path,"SupplementaryFig4.pdf"), plot = supp, width = 30, height = 10, units = "in")
ggsave(paste0(fig_path,"SupplementaryFig4.png"), plot = supp, width = 30, height = 10, units = "in")


```
*Supplementary Figure 4* Effect of simulation budget on relative error of MAP estimate and width of HDIs for inference on single synthetic observations. The grey line in (A) indicates a relative error of zero (i.e., no difference between MAP parameters and true parameters).
